---
import { cn } from '@/utils/cn';
import { LEAD_API_ENDPOINT } from '@/config/site';

interface Props {
	formId?: string;
	initialStep?: number;
	class?: string;
}

const {
	formId = 'lead-form',
	initialStep = 1,
	class: className = ''
} = Astro.props;

const leadApiEndpoint = LEAD_API_ENDPOINT;
---

<div
	class={cn('lead-form-container', className)}
	data-lead-form={formId}
	data-initial-step={initialStep}
>
	<form id={formId} class="lead-form" novalidate>
		<div class="steps-container">
			<slot />
		</div>

		<div class="mt-8 pt-6 border-t border-outline">
			<div class="navigation-buttons flex flex-row items-center justify-between gap-4">
				<button
					type="button"
					class="back-btn hidden items-center justify-center gap-2 text-base font-medium text-foreground hover:text-bronze transition-colors cursor-pointer"
					data-action="prev"
				>
					<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
					</svg>
					<span>Zurück</span>
				</button>

				<div class="privacy-text-mobile space-y-2 text-center hidden md:hidden">
					<p class="text-sm opacity-70">100 % anonym – keine Weitergabe Ihrer Daten</p>
					<p class="text-xs opacity-50">Kommt es zu keinem Auftrag, löschen wir Ihre Daten spätestens nach 14 Tagen automatisch.</p>
				</div>

				<button
					type="button"
					class="next-btn cta-primary text-white font-semibold px-6 py-3 rounded-xl flex items-center justify-center gap-2 text-base transition-colors w-full md:w-auto"
					data-action="next"
				>
					<span>Weiter</span>
					<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
					</svg>
				</button>

				<button
					type="button"
					class="submit-btn hidden cta-primary text-white font-semibold px-6 py-3 rounded-xl text-base transition-colors w-full md:w-auto"
					data-action="submit"
				>
					Jetzt unverbindlich anfragen
				</button>
			</div>

			<div id="form-error" class="hidden mt-4 p-4 rounded-lg bg-red-100 text-red-800 text-center">
				<p class="text-sm"></p>
			</div>

			<div class="privacy-text space-y-2 text-center mt-6 hidden max-md:hidden">
				<p class="text-sm opacity-70">100 % anonym – keine Weitergabe Ihrer Daten</p>
				<p class="text-xs opacity-50">Kommt es zu keinem Auftrag, löschen wir Ihre Daten spätestens nach 14 Tagen automatisch.</p>
			</div>
		</div>
	</form>
</div>

<style is:global>
	.is-invalid {
		border-color: var(--color-error) !important;
		background-color: var(--color-error-bg) !important;
	}

	.is-invalid:focus {
		--tw-ring-color: var(--color-error);
	}

	.field-error {
		color: var(--color-error);
		font-size: 0.875rem;
		margin-top: 0.25rem;
	}
</style>

<script define:vars={{ formId, leadApiEndpoint, isDev: import.meta.env.DEV }}>
	document.addEventListener('DOMContentLoaded', () => {
		const container = document.querySelector(`[data-lead-form="${formId}"]`);
		const form = document.getElementById(formId);

		if (!container || !form) return;

		const steps = form.querySelectorAll('[data-step]');
		const backBtn = form.querySelector('[data-action="prev"]');
		const nextBtn = form.querySelector('[data-action="next"]');
		const submitBtn = form.querySelector('.submit-btn');
		const privacyText = form.querySelector('.privacy-text');
		const privacyTextMobile = form.querySelector('.privacy-text-mobile');
		const navigationButtons = form.querySelector('.navigation-buttons');

		const totalSteps = steps.length;
		let currentStep = parseInt(container.getAttribute('data-initial-step') || '1', 10);
		let isInitialLoad = true;
		let isSubmitting = false;

		let formData = {};

		try {
			const savedData = sessionStorage.getItem(`${formId}_data`);
			if (savedData) {
				formData = JSON.parse(savedData);
			}
		} catch (e) {
			if (isDev) console.warn('Could not load saved form data:', e);
		}

		function saveFormData() {
			try {
				sessionStorage.setItem(`${formId}_data`, JSON.stringify(formData));
			} catch (e) {
				if (isDev) console.warn('Could not save form data:', e);
			}
		}

		function collectStepData(stepNum) {
			const step = form.querySelector(`[data-step="${stepNum}"]`);
			if (!step) return;

			const inputs = step.querySelectorAll('input, textarea, select');
			inputs.forEach((input) => {
				const name = input.getAttribute('name');
				if (!name) return;

				if (input.type === 'checkbox') {
					if (!formData[name]) formData[name] = [];
					if (input.checked) {
						if (!formData[name].includes(input.value)) {
							formData[name].push(input.value);
						}
					} else {
						formData[name] = formData[name].filter(v => v !== input.value);
					}
				} else if (input.type === 'radio') {
					if (input.checked) {
						formData[name] = input.value;
					}
				} else {
					formData[name] = input.value;
				}
			});

			saveFormData();
		}

		function restoreStepData(stepNum) {
			const step = form.querySelector(`[data-step="${stepNum}"]`);
			if (!step) return;

			const inputs = step.querySelectorAll('input, textarea, select');
			inputs.forEach((input) => {
				const name = input.getAttribute('name');
				if (!name || !formData[name]) return;

				if (input.type === 'checkbox') {
					input.checked = formData[name].includes(input.value);
					input.dispatchEvent(new Event('change', { bubbles: true }));
				} else if (input.type === 'radio') {
					input.checked = formData[name] === input.value;
				} else {
					input.value = formData[name];
					if (input.hasAttribute('data-slider-input')) {
						const display = step.querySelector(`[data-slider-display]`);
						if (display) display.value = input.value;
					}
				}
			});
		}

		function updateUI() {
			steps.forEach((step, index) => {
				const stepNum = index + 1;
				if (stepNum === currentStep) {
					step.classList.remove('hidden');
					step.setAttribute('aria-hidden', 'false');

					const stepTitle = step.getAttribute('data-step-title');
					const stepSubtitle = step.getAttribute('data-step-subtitle');

					const pageTitle = document.querySelector('.step-page-title');
					const pageSubtitle = document.querySelector('.step-page-subtitle');

					if (pageTitle && stepTitle) {
						pageTitle.textContent = stepTitle;
					}
					if (pageSubtitle && stepSubtitle) {
						pageSubtitle.textContent = stepSubtitle;
					}
				} else {
					step.classList.add('hidden');
					step.setAttribute('aria-hidden', 'true');
				}
			});

			if (backBtn) {
				if (currentStep > 1) {
					backBtn.classList.remove('hidden');
					backBtn.classList.add('flex');
				} else {
					backBtn.classList.add('hidden');
					backBtn.classList.remove('flex');
				}
			}

			if (nextBtn && submitBtn) {
				if (currentStep === totalSteps) {
					nextBtn.classList.add('hidden');
					submitBtn.classList.remove('hidden');
				} else {
					nextBtn.classList.remove('hidden');
					submitBtn.classList.add('hidden');
				}
			}

			if (privacyText) {
				if (currentStep === totalSteps) {
					privacyText.classList.remove('hidden');
				} else {
					privacyText.classList.add('hidden');
				}
			}

			if (privacyTextMobile) {
				if (currentStep === totalSteps) {
					privacyTextMobile.classList.remove('hidden');
					privacyTextMobile.style.display = 'block';
				} else {
					privacyTextMobile.classList.add('hidden');
					privacyTextMobile.style.display = '';
				}
			}

			if (privacyText) {
				privacyText.classList.add('hidden');
			}

			if (navigationButtons) {
				if (currentStep === totalSteps) {
					navigationButtons.classList.remove('flex-row', 'justify-between', 'md:justify-end', 'items-center');
					navigationButtons.classList.add('flex-col', 'md:items-center');
					if (submitBtn) {
						submitBtn.classList.add('order-1');
					}
					if (privacyTextMobile) {
						privacyTextMobile.classList.add('order-2');
					}
					if (backBtn) {
						backBtn.classList.add('w-full', 'md:w-auto', 'order-3');
					}
				} else if (currentStep === 1) {
					// Step 1: align button to the right on desktop
					navigationButtons.classList.remove('flex-col', 'md:items-center', 'justify-between');
					navigationButtons.classList.add('flex-row', 'md:justify-end', 'items-center');
					if (submitBtn) {
						submitBtn.classList.remove('order-1');
					}
					if (privacyTextMobile) {
						privacyTextMobile.classList.remove('order-2');
					}
					if (backBtn) {
						backBtn.classList.remove('w-full', 'md:w-auto', 'order-3');
					}
				} else {
					// Steps 2-5: space between back and next buttons
					navigationButtons.classList.remove('flex-col', 'md:items-center', 'md:justify-end');
					navigationButtons.classList.add('flex-row', 'justify-between', 'items-center');
					if (submitBtn) {
						submitBtn.classList.remove('order-1');
					}
					if (privacyTextMobile) {
						privacyTextMobile.classList.remove('order-2');
					}
					if (backBtn) {
						backBtn.classList.remove('w-full', 'md:w-auto', 'order-3');
					}
				}
			}

			const stepIndicator = document.querySelector('.step-indicator span');
			if (stepIndicator) {
				stepIndicator.textContent = `Schritt ${currentStep} von ${totalSteps}`;
			}

			const progressBar = document.querySelector('.step-indicator .bg-bronze');
			if (progressBar) {
				progressBar.style.width = `${(currentStep / totalSteps) * 100}%`;
			}

			restoreStepData(currentStep);

			if (!isInitialLoad) {
				window.scrollTo({ top: 0, behavior: 'smooth' });
			}
			isInitialLoad = false;
		}

		function clearStepErrors(step) {
			step.querySelectorAll('.field-error').forEach(el => el.remove());
			step.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
		}

		function getErrorMessage(input) {
			if (input.validity.valueMissing) return 'Dieses Feld ist erforderlich.';
			if (input.validity.typeMismatch && input.type === 'email') return 'Bitte geben Sie eine gültige E-Mail-Adresse ein.';
			if (input.validity.typeMismatch && input.type === 'tel') return 'Bitte geben Sie eine gültige Telefonnummer ein.';
			return 'Bitte überprüfen Sie Ihre Eingabe.';
		}

		function showFieldError(input, message) {
			input.classList.add('is-invalid');
			const errorEl = document.createElement('p');
			errorEl.className = 'field-error';
			errorEl.textContent = message;

			if (input.type === 'checkbox' || input.type === 'radio') {
				const label = input.closest('label');
				if (label && label.parentElement) {
					label.parentElement.appendChild(errorEl);
				}
			} else {
				const parent = input.parentElement;
				if (parent) {
					parent.appendChild(errorEl);
				}
			}
		}

		function showGridError(container, message) {
			const errorEl = document.createElement('p');
			errorEl.className = 'field-error';
			errorEl.textContent = message;
			container.after(errorEl);
		}

		function validateStep(stepNum) {
			const step = form.querySelector(`[data-step="${stepNum}"]`);
			if (!step) return true;

			clearStepErrors(step);

			let isValid = true;
			let firstInvalidField = null;

			if (stepNum === 6) {
				const sections = {
					contact: { fields: ['email', 'phone'], message: 'Bitte füllen Sie alle Kontaktinformationen aus.' },
					person: { fields: ['salutation', 'first_name', 'last_name'], message: 'Bitte füllen Sie alle Ansprechpartner-Felder aus.' },
					address: { fields: ['street', 'street_number', 'postal_code', 'city'], message: 'Bitte füllen Sie alle Adressfelder aus.' },
					privacy: { fields: ['privacy'], message: 'Bitte akzeptieren Sie die Datenschutzerklärung.', skipHighlight: true }
				};

				for (const [key, section] of Object.entries(sections)) {
					let sectionHasError = false;
					let sectionContainer = null;

					section.fields.forEach(fieldName => {
						const input = step.querySelector(`[name="${fieldName}"]`);
						if (input && input.hasAttribute('required') && !input.checkValidity()) {
							if (!section.skipHighlight) {
								input.classList.add('is-invalid');
							}
							sectionHasError = true;
							if (!firstInvalidField) firstInvalidField = input;

							if (!sectionContainer) {
								if (key === 'contact' || key === 'person' || key === 'address') {
									sectionContainer = input.closest('.space-y-4');
								}
							}
						}
					});

					if (sectionHasError) {
						const errorEl = document.createElement('p');
						errorEl.className = 'field-error';
						errorEl.textContent = section.message;

						if (key === 'privacy') {
							const privacyLabel = step.querySelector('label:has([name="privacy"])');
							if (privacyLabel) {
								privacyLabel.insertAdjacentElement('afterend', errorEl);
							}
						} else if (sectionContainer) {
							sectionContainer.insertAdjacentElement('afterend', errorEl);
						}
						isValid = false;
					}
				}

				const hasDifferentAddressCheckbox = step.querySelector('input[name="has_different_address"]');
				if (hasDifferentAddressCheckbox && hasDifferentAddressCheckbox.checked) {
					const jobAddressFields = ['job_street', 'job_street_number', 'job_postal_code', 'job_city'];
					let jobAddressHasError = false;

					jobAddressFields.forEach(fieldName => {
						const input = step.querySelector(`[name="${fieldName}"]`);
						if (input && input.hasAttribute('required') && !input.checkValidity()) {
							input.classList.add('is-invalid');
							jobAddressHasError = true;
							if (!firstInvalidField) firstInvalidField = input;
						}
					});

					if (jobAddressHasError) {
						const errorEl = document.createElement('p');
						errorEl.className = 'field-error';
						errorEl.textContent = 'Bitte füllen Sie alle Felder der Einsatzadresse aus.';
						const differentAddressSection = step.querySelector('#different-address');
						if (differentAddressSection) {
							differentAddressSection.insertAdjacentElement('afterend', errorEl);
						}
						isValid = false;
					}
				}

				const hasDifferentContactCheckbox = step.querySelector('input[name="has_different_contact"]');
				if (hasDifferentContactCheckbox && hasDifferentContactCheckbox.checked) {
					const altContactFields = ['alt_salutation', 'alt_first_name', 'alt_last_name', 'alt_email', 'alt_phone'];
					let altContactHasError = false;

					altContactFields.forEach(fieldName => {
						const input = step.querySelector(`[name="${fieldName}"]`);
						if (input && input.hasAttribute('required') && !input.checkValidity()) {
							input.classList.add('is-invalid');
							altContactHasError = true;
							if (!firstInvalidField) firstInvalidField = input;
						}
					});

					if (altContactHasError) {
						const errorEl = document.createElement('p');
						errorEl.className = 'field-error';
						errorEl.textContent = 'Bitte füllen Sie alle Pflichtfelder des Ansprechpartners aus.';
						const differentContactSection = step.querySelector('#different-contact');
						if (differentContactSection) {
							differentContactSection.insertAdjacentElement('afterend', errorEl);
						}
						isValid = false;
					}
				}
			} else {
				const requiredInputs = step.querySelectorAll('[required]');
				requiredInputs.forEach((input) => {
					if (!input.checkValidity()) {
						isValid = false;
						showFieldError(input, getErrorMessage(input));
						if (!firstInvalidField) firstInvalidField = input;
					}
				});
			}

			if (stepNum === 1) {
				const checkedServices = step.querySelectorAll('input[name="services[]"]:checked');
				if (checkedServices.length === 0) {
					isValid = false;
					const serviceGrid = step.querySelector('.service-grid');
					if (serviceGrid) {
						showGridError(serviceGrid, 'Bitte wählen Sie mindestens eine Leistung aus.');
						if (!firstInvalidField) firstInvalidField = serviceGrid;
					}
				}
			}

			if (stepNum === 2) {
				const checkedObjectType = step.querySelectorAll('input[name="object_type"]:checked');
				if (checkedObjectType.length === 0) {
					isValid = false;
					const objectTypeGrid = step.querySelector('.object-type-grid');
					if (objectTypeGrid) {
						showGridError(objectTypeGrid, 'Bitte wählen Sie eine Objektart aus.');
						if (!firstInvalidField) firstInvalidField = objectTypeGrid;
					}
				}

				const checkedElevator = step.querySelectorAll('input[name="elevator"]:checked');
				if (checkedElevator.length === 0) {
					isValid = false;
					const elevatorGrid = step.querySelector('.elevator-grid');
					if (elevatorGrid) {
						showGridError(elevatorGrid, 'Bitte geben Sie an, ob ein Aufzug vorhanden ist.');
						if (!firstInvalidField) firstInvalidField = elevatorGrid;
					}
				}

				const checkedFurnishing = step.querySelectorAll('input[name="furnishing"]:checked');
				if (checkedFurnishing.length === 0) {
					isValid = false;
					const furnishingGrid = step.querySelector('.furnishing-grid');
					if (furnishingGrid) {
						showGridError(furnishingGrid, 'Bitte wählen Sie einen Möblierungsgrad aus.');
						if (!firstInvalidField) firstInvalidField = furnishingGrid;
					}
				}
			}

			if (stepNum === 3) {
				const checkedCondition = step.querySelectorAll('input[name="condition"]:checked');
				if (checkedCondition.length === 0) {
					isValid = false;
					const conditionGrid = step.querySelector('.condition-grid');
					if (conditionGrid) {
						showGridError(conditionGrid, 'Bitte wählen Sie den Zustand der Räume aus.');
						if (!firstInvalidField) firstInvalidField = conditionGrid;
					}
				}
			}

			if (stepNum === 5) {
				const checkedTiming = step.querySelectorAll('input[name="timing"]:checked');
				if (checkedTiming.length === 0) {
					isValid = false;
					const timingGrid = step.querySelector('.timing-grid');
					if (timingGrid) {
						showGridError(timingGrid, 'Bitte wählen Sie eine Option aus.');
						if (!firstInvalidField) firstInvalidField = timingGrid;
					}
				} else {
					const selectedTiming = step.querySelector('input[name="timing"]:checked');
					if (selectedTiming && selectedTiming.value === 'specific_date') {
						const dateField = step.querySelector('input[name="preferred_date"]');
						if (!dateField || !dateField.value) {
							isValid = false;
							const timingGrid = step.querySelector('.timing-grid');
							if (timingGrid) {
								showGridError(timingGrid, 'Bitte wählen Sie ein Datum aus.');
								if (!firstInvalidField) firstInvalidField = timingGrid;
							}
						} else {
							const selectedDate = dateField.value;
							const today = new Date().toISOString().split('T')[0];

							if (selectedDate < today) {
								isValid = false;
								const timingGrid = step.querySelector('.timing-grid');
								if (timingGrid) {
									showGridError(timingGrid, 'Bitte wählen Sie ein Datum in der Zukunft aus.');
									if (!firstInvalidField) firstInvalidField = timingGrid;
								}
							}
						}
					}
				}
			}

			if (firstInvalidField) {
				firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
			}

			return isValid;
		}

		function nextStep() {
			if (!validateStep(currentStep)) return;

			collectStepData(currentStep);

			if (currentStep < totalSteps) {
				currentStep++;
				updateUI();
			}
		}

		function prevStep() {
			collectStepData(currentStep);

			if (currentStep > 1) {
				currentStep--;
				updateUI();
			}
		}

		function showErrorMessage(message) {
			const errorEl = document.getElementById('form-error');
			if (errorEl) {
				const textEl = errorEl.querySelector('p');
				if (textEl) textEl.textContent = message;
				errorEl.classList.remove('hidden');
				errorEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
			}
		}

		function hideErrorMessage() {
			const errorEl = document.getElementById('form-error');
			if (errorEl) {
				errorEl.classList.add('hidden');
			}
		}

		async function handleSubmit() {
			if (!validateStep(currentStep)) return;

			if (isSubmitting) {
				if (isDev) console.warn('Form is already being submitted');
				return;
			}

			collectStepData(currentStep);

			const submitButton = form.querySelector('.submit-btn');
			if (!submitButton) return;

			hideErrorMessage();
			isSubmitting = true;

			const originalText = submitButton.innerHTML;
			submitButton.disabled = true;
			submitButton.innerHTML = '<span>Wird gesendet...</span>';

			const filesDataInput = document.getElementById('lead-form-files-data');
			const uploadedFiles = filesDataInput && filesDataInput.value
				? JSON.parse(filesDataInput.value)
				: [];

			const submitData = {
				...formData,
				timestamp: new Date().toISOString(),
				source: 'lead-form',
				fileUrls: uploadedFiles
			};

			if (leadApiEndpoint) {
				try {
					const response = await fetch(leadApiEndpoint, {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify(submitData)
					});

					if (response.ok) {
						if (isDev) console.log('Lead form submitted successfully!');

						if (typeof window !== 'undefined' && window.dataLayer) {
							window.dataLayer.push({
								'event': 'lead_form_submit',
								'form_type': 'lead',
								'form_location': 'lead_form'
							});
						}

						sessionStorage.removeItem(`${formId}_data`);

						window.location.href = '/anfrage/danke/';
					} else {
						throw new Error('Server error');
					}
				} catch (error) {
					if (isDev) console.error('Form submission error:', error);
					showErrorMessage('Es ist ein Fehler aufgetreten. Bitte versuchen Sie es erneut oder kontaktieren Sie uns direkt per Telefon.');
					isSubmitting = false;
					submitButton.disabled = false;
					submitButton.innerHTML = originalText;
				}
			} else {
				if (isDev) console.log('No endpoint configured, redirecting...');
				sessionStorage.removeItem(`${formId}_data`);
				document.cookie = 'form_submitted=true; path=/; max-age=60; SameSite=Lax';
				window.location.href = '/anfrage/danke/';
			}
		}

		backBtn?.addEventListener('click', prevStep);
		nextBtn?.addEventListener('click', nextStep);
		submitBtn?.addEventListener('click', handleSubmit);

		function clearErrorOnChange(input) {
			input.classList.remove('is-invalid');

			if (input.type === 'checkbox' || input.type === 'radio') {
				const gridContainer = input.closest('.service-grid, .object-type-grid, .elevator-grid, .furnishing-grid, .condition-grid, .clutter-grid, .timing-grid');
				if (gridContainer) {
					const nextSibling = gridContainer.nextElementSibling;
					if (nextSibling && nextSibling.classList.contains('field-error')) {
						nextSibling.remove();
					}
				}
				const label = input.closest('label');
				if (label && label.parentElement) {
					const errorEl = label.parentElement.querySelector('.field-error');
					if (errorEl) errorEl.remove();
				}

				if (input.name === 'privacy') {
					const label = input.closest('label');
					if (label) {
						const nextSibling = label.nextElementSibling;
						if (nextSibling && nextSibling.classList.contains('field-error')) {
							nextSibling.remove();
						}
					}
				}
			} else {
				const step6Fields = ['email', 'phone', 'salutation', 'first_name', 'last_name', 'street', 'street_number', 'postal_code', 'city'];
				const jobAddressFields = ['job_street', 'job_street_number', 'job_postal_code', 'job_city'];
				const altContactFields = ['alt_salutation', 'alt_first_name', 'alt_last_name', 'alt_email', 'alt_phone'];

				if (step6Fields.includes(input.name)) {
					const sectionContainer = input.closest('.space-y-4');
					if (sectionContainer) {
						const nextSibling = sectionContainer.nextElementSibling;
						if (nextSibling && nextSibling.classList.contains('field-error')) {
							nextSibling.remove();
						}
					}
				} else if (jobAddressFields.includes(input.name)) {
					const step6 = input.closest('[data-step="6"]');
					if (step6) {
						const differentAddressSection = step6.querySelector('#different-address');
						if (differentAddressSection) {
							const nextSibling = differentAddressSection.nextElementSibling;
							if (nextSibling && nextSibling.classList.contains('field-error')) {
								nextSibling.remove();
							}
						}
					}
				} else if (altContactFields.includes(input.name)) {
					const step6 = input.closest('[data-step="6"]');
					if (step6) {
						const differentContactSection = step6.querySelector('#different-contact');
						if (differentContactSection) {
							const nextSibling = differentContactSection.nextElementSibling;
							if (nextSibling && nextSibling.classList.contains('field-error')) {
								nextSibling.remove();
							}
						}
					}
				} else {
					const parent = input.parentElement;
					if (parent) {
						const errorEl = parent.querySelector('.field-error');
						if (errorEl) errorEl.remove();
					}
				}

				if (input.name === 'preferred_date') {
					const step5 = input.closest('[data-step="5"]');
					if (step5) {
						const timingGrid = step5.querySelector('.timing-grid');
						if (timingGrid) {
							const nextSibling = timingGrid.nextElementSibling;
							if (nextSibling && nextSibling.classList.contains('field-error')) {
								nextSibling.remove();
							}
						}
					}
				}
			}
		}

		form.querySelectorAll('input, select, textarea').forEach((input) => {
			const eventType = (input.type === 'checkbox' || input.type === 'radio') ? 'change' : 'input';
			input.addEventListener(eventType, () => clearErrorOnChange(input));
		});

		updateUI();
	});
</script>
