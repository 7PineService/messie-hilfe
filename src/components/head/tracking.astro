---
import { COOKIEYES_SCRIPT_URL, COOKIEYES_ENABLED } from '@/config/tracking';

interface Props {
  gtmId: string;
}

const { gtmId } = Astro.props;
const isDev = import.meta.env.DEV;
---

{COOKIEYES_ENABLED && COOKIEYES_SCRIPT_URL && (
  <>
    <script is:inline id="cookieyes" type="text/javascript" src={COOKIEYES_SCRIPT_URL}></script>
    {isDev && (
      <script is:inline>
        document.getElementById('cookieyes')?.addEventListener('error', function() {
          console.warn('CookieYes failed to load - check domain registration');
        });
      </script>
    )}
  </>
)}

<script is:inline define:vars={{ gtmId }}>
  window.dataLayer = window.dataLayer || [];
  window.gtmLoaded = window.gtmLoaded || false;
  window.trackingInitialized = window.trackingInitialized || false;

  function loadGTM() {
    if (window.gtmLoaded) {
      console.debug('[Tracking] GTM already loaded, skipping');
      return;
    }
    window.gtmLoaded = true;
    console.log('[Tracking] Loading GTM:', gtmId);

    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;
    f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer',gtmId);
  }

  function checkConsent() {
    console.debug('[Tracking] Checking consent...');

    if (typeof window.getCkyConsent === 'function') {
      try {
        var consent = window.getCkyConsent();
        console.debug('[Tracking] Consent data:', consent);

        if (consent && consent.categories) {
          if (consent.categories.analytics || consent.categories.advertisement) {
            console.log('[Tracking] Consent granted - analytics:', consent.categories.analytics, 'advertisement:', consent.categories.advertisement);
            loadGTM();
            window.dispatchEvent(new CustomEvent('tracking_consent_granted'));
            console.debug('[Tracking] tracking_consent_granted event dispatched');
          } else {
            console.debug('[Tracking] No analytics/advertisement consent');
          }
        }
      } catch (e) {
        console.debug('[Tracking] getCkyConsent failed', e);
      }
    } else {
      console.debug('[Tracking] getCkyConsent not available yet');
    }
  }

  document.addEventListener('cookieyes_banner_load', function() {
    console.log('[Tracking] cookieyes_banner_load event fired');
    checkConsent();
  });

  document.addEventListener('cookieyes_consent_update', function() {
    console.log('[Tracking] cookieyes_consent_update event fired');
    checkConsent();
  });

  console.debug('[Tracking] Initial consent check on page load');
  checkConsent();
</script>

<Fragment slot="body-start">
  <noscript>
    <iframe src={`https://www.googletagmanager.com/ns.html?id=${gtmId}`} height="0" width="0" style="display:none;visibility:hidden"></iframe>
  </noscript>
</Fragment>

<script>
  import { initEventTracking } from '@/scripts/event-tracking';

  const init = () => {
    if (window.trackingInitialized) {
      console.debug('[Tracking] Event tracking already initialized, skipping');
      return;
    }
    window.trackingInitialized = true;
    console.log('[Tracking] Initializing event tracking...');

    if ('requestIdleCallback' in window) {
      requestIdleCallback(() => initEventTracking(import.meta.env.DEV));
    } else {
      setTimeout(() => initEventTracking(import.meta.env.DEV), 1);
    }
  };

  window.addEventListener('tracking_consent_granted', () => {
    console.log('[Tracking] tracking_consent_granted event received');
    init();
  });

  if (window.gtmLoaded) {
    console.log('[Tracking] GTM already loaded, initializing event tracking');
    init();
  }
</script>
