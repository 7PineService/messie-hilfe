---
import { COOKIEYES_SCRIPT_URL, COOKIEYES_ENABLED } from '@/config/tracking';

interface Props {
  gtmId: string;
}

const { gtmId } = Astro.props;
const isDev = import.meta.env.DEV;
---

{COOKIEYES_ENABLED && COOKIEYES_SCRIPT_URL && (
  <>
    <script is:inline id="cookieyes" type="text/javascript" src={COOKIEYES_SCRIPT_URL}></script>
    {isDev && (
      <script is:inline>
        document.getElementById('cookieyes')?.addEventListener('error', function() {
          console.warn('CookieYes failed to load - check domain registration');
        });
      </script>
    )}
  </>
)}

<script is:inline define:vars={{ gtmId }}>
  window.dataLayer = window.dataLayer || [];
  window.gtmLoaded = window.gtmLoaded || false;
  window.trackingInitialized = window.trackingInitialized || false;

  function loadGTM() {
    if (window.gtmLoaded) return;
    window.gtmLoaded = true;

    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;
    f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer',gtmId);
  }

  function checkConsent() {
    if (typeof window.getCkyConsent === 'function') {
      try {
        var consent = window.getCkyConsent();
        if (consent && consent.categories) {
          if (consent.categories.analytics || consent.categories.advertisement) {
            loadGTM();
            window.dispatchEvent(new CustomEvent('tracking_consent_granted'));
          }
        }
      } catch (e) {
        console.debug('getCkyConsent failed', e);
      }
    }
  }

  document.addEventListener('cookieyes_banner_load', function() {
    checkConsent();
  });

  document.addEventListener('cookieyes_consent_update', function() {
    checkConsent();
  });

  checkConsent();
</script>

<Fragment slot="body-start">
  <noscript>
    <iframe src={`https://www.googletagmanager.com/ns.html?id=${gtmId}`} height="0" width="0" style="display:none;visibility:hidden"></iframe>
  </noscript>
</Fragment>

<script>
  import { initEventTracking } from '@/lib/analytics';

  const init = () => {
    if (window.trackingInitialized) return;
    window.trackingInitialized = true;

    if ('requestIdleCallback' in window) {
      requestIdleCallback(() => initEventTracking({ debug: import.meta.env.DEV }));
    } else {
      setTimeout(() => initEventTracking({ debug: import.meta.env.DEV }), 1);
    }
  };

  window.addEventListener('tracking_consent_granted', init);

  if (window.gtmLoaded) {
    init();
  }
</script>
