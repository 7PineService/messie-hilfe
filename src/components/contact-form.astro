---
import { CONTACT_API_ENDPOINT } from '@/config/site';

interface Props {
	formId?: string;
	fileListId?: string;
	formMessageId?: string;
	privacyCheckboxId?: string;
	nameInputId?: string;
	contactInputId?: string;
	messageInputId?: string;
	filesInputId?: string;
	showTitle?: boolean;
	overlayStyle?: boolean;
	formTitle?: string;
	submitButtonText?: string;
	formType?: 'anonym' | 'contact';
	formLocation?: string;
}

const {
	formId = 'contact-form',
	fileListId = 'file-list',
	formMessageId = 'form-message',
	privacyCheckboxId = 'privacy',
	nameInputId = 'name',
	contactInputId = 'contact',
	messageInputId = 'message',
	filesInputId = 'files',
	showTitle = true,
	overlayStyle = false,
	formTitle = 'Anonym anfragen',
	submitButtonText = 'Anonym anfragen',
	formType = 'contact',
	formLocation = null
} = Astro.props;

const contactApiEndpoint = CONTACT_API_ENDPOINT;

const containerClass = overlayStyle
	? 'px-4 md:px-6 pb-4 md:pb-6'
	: 'bg-surface-secondary rounded-2xl shadow-xl px-6 py-6';
const inputBgClass = 'bg-surface-input';
const borderClass = 'border-border-primary';
const focusBorderClass = 'focus:ring-2 focus:ring-border-primary focus:border-border-primary';
const buttonClass = 'cta-primary w-full text-white font-semibold px-5 py-2.5 border-2 border-transparent rounded-lg flex items-center justify-center space-x-2 text-base';
---

<div class={`${containerClass} ${!overlayStyle ? 'text-center' : ''}`} id={overlayStyle ? undefined : 'anfrage'}>
	{showTitle && (
		<h2 class={`text-2xl ${overlayStyle ? 'font-semibold' : 'md:text-3xl font-bold'} text-center ${overlayStyle ? '' : 'mb-4'}`}>
			{formTitle}
		</h2>
	)}
	
	<form
		id={formId}
		class="space-y-3 min-[1920px]:space-y-4"
		method="POST"
		action={contactApiEndpoint || '#'}
	>
		<div>
			<input
				type="text"
				id={nameInputId}
				name="name"
				class={`w-full px-3 py-2 min-[1920px]:px-4 min-[1920px]:py-3 text-sm min-[1920px]:text-base border ${borderClass} rounded-lg ${focusBorderClass} transition-colors ${inputBgClass}`}
				placeholder="Name (optional)"
			/>
		</div>

		<div>
			<input
				type="text"
				id={contactInputId}
				name="contact"
				required
				class={`w-full px-3 py-2 min-[1920px]:px-4 min-[1920px]:py-3 text-sm min-[1920px]:text-base border ${borderClass} rounded-lg ${focusBorderClass} transition-colors ${inputBgClass}`}
				placeholder="Telefon oder E-Mail"
			/>
		</div>

		<div>
			<textarea
				id={messageInputId}
				name="message"
				rows={overlayStyle ? 3 : 4}
				required
				class={`w-full px-3 py-2 min-[1920px]:px-4 min-[1920px]:py-3 text-sm min-[1920px]:text-base border ${borderClass} rounded-lg ${focusBorderClass} transition-colors ${inputBgClass} resize-none`}
				placeholder="Ihre Nachricht"
			></textarea>
		</div>

		<div>
			<div class={`border-2 border-dashed ${borderClass} rounded-lg p-2.5 hover:border-border-primary transition-colors cursor-pointer ${inputBgClass}`}>
				<input
					type="file"
					id={filesInputId}
					name="files"
					multiple
					class="hidden"
					accept="image/*,.pdf"
				/>
				<label for={filesInputId} class="cursor-pointer flex items-center gap-2">
					<div class="w-10 h-10 rounded-lg flex items-center justify-center shrink-0 border border-dashed" style="background-color: #fbe5ce; border-color: #eacb62;">
						<svg class="w-4 h-4 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
							<path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
						</svg>
					</div>
					<p class="text-xs opacity-80">
						<span class="font-medium">Dateien hinzufügen (optional)</span>
					</p>
				</label>
			</div>
			<div id={fileListId} class="mt-1.5 space-y-1"></div>
		</div>

		<div class="flex items-start gap-2 pt-1">
			<input
				type="checkbox"
				id={privacyCheckboxId}
				name="privacy"
				required
				class="mt-0.5 w-4 h-4 border-border-primary rounded focus:ring-border-primary focus:ring-2"
			/>
			<label for={privacyCheckboxId} class="text-xs opacity-80 leading-normal">
				Ich habe die Datenschutzerklärung zur Kenntnis genommen
			</label>
		</div>

		<button
			type="submit"
			class={buttonClass}
		>
			<span>{submitButtonText}</span>
			<svg class="w-7 h-7" viewBox="0 0 24 24" fill="none">
				<circle cx="12" cy="12" r="10" fill="white" />
				<path d="M10 8l6 4-6 4V8z" fill="var(--color-primary)" />
			</svg>
		</button>

		<div class="text-center pt-2 space-y-1">
			<p class="text-xs opacity-60">
				100 % anonym – keine Weitergabe Ihrer Daten
			</p>
			<p class="text-xs opacity-40">
				Kommt es zu keinem Auftrag, löschen wir Ihre Daten spätestens nach 14 Tagen automatisch.
			</p>
		</div>
	</form>

	<div id={`${formId}-success`} class="hidden text-center py-8">
		<div class="mb-4 flex justify-center">
			<svg class="w-16 h-16 md:w-20 md:h-20 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
			</svg>
		</div>

		<h3 class="text-2xl md:text-3xl font-semibold mb-4">Vielen Dank.</h3>

		<div class="space-y-3 text-base opacity-80">
			{formType === 'anonym' ? (
				<>
					<p>Ihre anonyme Anfrage ist bei uns angekommen.</p>
					<p>Wir melden uns – sofern möglich – zeitnah bei Ihnen.</p>
					{overlayStyle && <p class="opacity-60">Sie können dieses Fenster jetzt schließen.</p>}
				</>
			) : (
				<>
					<p>Ihre anonyme Anfrage ist bei uns angekommen.</p>
					<p>Wir melden uns – sofern möglich – zeitnah bei Ihnen.</p>
				</>
			)}
		</div>
	</div>
</div>

<script define:vars={{ contactApiEndpoint, formId, fileListId, formMessageId, privacyCheckboxId, filesInputId, overlayStyle, isDev: import.meta.env.DEV, formType, formLocation }}>

	const form = document.getElementById(formId);
	let formMessage = null;
	const fileInput = document.getElementById(filesInputId);
	const fileList = document.getElementById(fileListId);
	const privacyCheckbox = document.getElementById(privacyCheckboxId);

	function getMessageElement() {
		if (!formMessage) {
			formMessage = document.createElement('div');
			formMessage.id = formMessageId;
			form.appendChild(formMessage);
		}
		return formMessage;
	}

	function showMessage(className, text) {
		const msg = getMessageElement();
		msg.className = className;
		msg.textContent = text;
	}

	function clearMessage() {
		if (formMessage && formMessage.parentNode) {
			formMessage.parentNode.removeChild(formMessage);
			formMessage = null;
		}
	}

	const successElement = document.getElementById(`${formId}-success`);

	function showSuccessState() {
		if (!form || !successElement) return;
		form.style.display = 'none';
		successElement.classList.remove('hidden');
		successElement.classList.add('block');
		successElement.scrollIntoView({ behavior: 'smooth', block: 'center' });

		const overlayTitle = document.getElementById('overlay-title');
		if (overlayTitle) {
			overlayTitle.style.display = 'none';
		}
	}

	function resetToFormState() {
		if (!form || !successElement) return;
		form.style.display = 'block';
		successElement.classList.add('hidden');
		successElement.classList.remove('block');

		const overlayTitle = document.getElementById('overlay-title');
		if (overlayTitle) {
			overlayTitle.style.display = '';
		}
	}

	let eventFired = false;

	function trackLeadGeneration() {
		if (eventFired) {
			if (isDev) console.warn('[Tracking] Event already fired, skipping duplicate');
			return;
		}

		if (typeof window === 'undefined' || !window.dataLayer) {
			if (isDev) console.warn('[Tracking] dataLayer not available');
			return;
		}

		let detectedFormLocation = formLocation;
		if (!detectedFormLocation) {
			if (overlayStyle) {
				detectedFormLocation = 'modal';
			} else if (formId.includes('hero')) {
				detectedFormLocation = 'hero';
			} else if (window.location.pathname.includes('kontakt')) {
				detectedFormLocation = 'kontakt';
			} else {
				detectedFormLocation = 'startseite';
			}
		}

		const eventData = {
			'event': 'contact_form_submit',
			'form_type': formType,
			'form_location': detectedFormLocation
		};

		if (isDev) {
			console.log('[Tracking] ✅ Firing contact_form_submit event');
			console.log('[Tracking] Event data:', eventData);
		}

		window.dataLayer.push(eventData);
		eventFired = true;
	}

	if (typeof window !== 'undefined') {
		const resetFunctionName = `resetFormTracking_${formId.replace(/-/g, '')}`;
		window[resetFunctionName] = () => {
			eventFired = false;
			resetToFormState();
			if (isDev) console.log(`[Tracking] Reset form tracking for ${formId}`);
		};
	}

	if (fileInput && fileList) {
		const fileInputEl = fileInput;
		const fileListEl = fileList;

		const fileMap = new Map();
		let fileIdCounter = 0;
		const MAX_FILE_SIZE = 40 * 1024 * 1024;

		async function uploadToSupabase(file) {
			// Request signed upload URL from API
			const urlResponse = await fetch('/api/upload-url', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({
					fileName: file.name,
					fileType: file.type,
					fileSize: file.size
				})
			});

			if (!urlResponse.ok) {
				const errorData = await urlResponse.json();
				throw new Error(errorData.error || 'Failed to get upload URL');
			}

			const { signedUrl, path, publicUrl } = await urlResponse.json();

			// Upload file to Supabase using signed URL
			const uploadResponse = await fetch(signedUrl, {
				method: 'PUT',
				body: file,
				headers: {
					'Content-Type': file.type,
					'x-upsert': 'false'
				}
			});

			if (!uploadResponse.ok) {
				throw new Error('Upload fehlgeschlagen');
			}

			return {
				url: publicUrl,
				path: path,
				name: file.name,
				size: file.size,
			};
		}

		async function addFile(file) {
			if (file.size > MAX_FILE_SIZE) {
				console.warn(`File "${file.name}" is too large. Max size: 40MB`);
				return;
			}

			const fileId = `file-${fileIdCounter++}`;

			const tempFileData = {
				name: file.name,
				size: file.size,
				status: 'uploading',
				url: null,
				path: null
			};

			fileMap.set(fileId, tempFileData);
			renderFileList();

			try {
				const uploadResult = await uploadToSupabase(file);

				fileMap.set(fileId, {
					...tempFileData,
					status: 'uploaded',
					url: uploadResult.url,
					path: uploadResult.path
				});
				renderFileList();
			} catch (error) {
				console.error('Upload error:', error);
				fileMap.set(fileId, {
					...tempFileData,
					status: 'error',
					error: error?.message || 'Unknown error'
				});
				renderFileList();
			}
		}

		function removeFile(fileId) {
			fileMap.delete(fileId);
			renderFileList();
		}

		function renderFileList() {
			fileListEl.innerHTML = '';
			const bgClass = overlayStyle ? 'bg-[#FFFBF0]' : 'bg-[var(--color-input-bg)]';

			fileMap.forEach((fileData, fileId) => {
				const fileItem = document.createElement('div');
				fileItem.className = `text-sm text-gray-600 flex items-center justify-between gap-2 p-2 ${bgClass} rounded border border-amber-200`;

				const fileInfo = document.createElement('div');
				fileInfo.className = 'flex items-center space-x-2 flex-1 min-w-0';

				let statusIcon = '';
				let statusText = '';

				if (fileData.status === 'uploading') {
					statusIcon = `<svg class="w-4 h-4 shrink-0 text-amber-600 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
					</svg>`;
					statusText = '<span class="text-amber-600 text-xs ml-2">Lädt...</span>';
				} else if (fileData.status === 'uploaded') {
					statusIcon = `<svg class="w-4 h-4 shrink-0 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
					</svg>`;
					statusText = '';
				} else if (fileData.status === 'error') {
					statusIcon = `<svg class="w-4 h-4 shrink-0 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
					</svg>`;
					statusText = '<span class="text-red-600 text-xs ml-2">Fehler</span>';
				}

				fileInfo.innerHTML = `
					${statusIcon}
					<span class="truncate">${fileData.name} (${(fileData.size / 1024).toFixed(1)} KB)</span>
					${statusText}
				`;

				const removeBtn = document.createElement('button');
				removeBtn.type = 'button';
				removeBtn.className = 'shrink-0 p-1 text-red-600 hover:text-red-800 hover:bg-red-50 rounded transition-colors';
				removeBtn.setAttribute('aria-label', 'Datei entfernen');
				removeBtn.disabled = fileData.status === 'uploading';
				removeBtn.innerHTML = `
					<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
					</svg>
				`;
				removeBtn.addEventListener('click', () => removeFile(fileId));

				fileItem.appendChild(fileInfo);
				fileItem.appendChild(removeBtn);
				fileListEl.appendChild(fileItem);
			});
		}

		fileInputEl.addEventListener('change', (e) => {
			const target = e.target;
			const newFiles = Array.from(target.files || []);
			newFiles.forEach(file => addFile(file));
			fileInputEl.value = '';
		});

		window[`getFileMap_${filesInputId}`] = () => fileMap;
	}

	if (form && contactApiEndpoint) {
		form.addEventListener('submit', async (e) => {
			e.preventDefault();

			if (privacyCheckbox && !privacyCheckbox.checked) {
				showMessage('mt-4 p-4 rounded-lg bg-red-100 text-red-800', 'Bitte bestätigen Sie die Datenschutzerklärung.');
				privacyCheckbox.focus();
				return;
			}

			const submitButton = form.querySelector('button[type="submit"]');
			if (!submitButton) return;
			const originalText = submitButton.innerHTML;
			submitButton.disabled = true;
			submitButton.innerHTML = '<span>Wird gesendet...</span>';

			const formData = new FormData(form);
			const data = {
				name: formData.get('name') || '',
				contact: formData.get('contact'),
				message: formData.get('message'),
				privacy: formData.get('privacy') === 'on',
				timestamp: new Date().toISOString(),
				source: formId.includes('overlay') ? 'overlay-form' : 'landing-page'
			};

			const getFileMapFn = window[`getFileMap_${filesInputId}`];
			const storedFileMap = getFileMapFn ? getFileMapFn() : null;

			const uploadedFiles = [];
			if (storedFileMap && storedFileMap.size > 0) {
				storedFileMap.forEach((fileData) => {
					if (fileData.status === 'uploaded' && fileData.url) {
						uploadedFiles.push({
							url: fileData.url,
							name: fileData.name,
							size: fileData.size,
							path: fileData.path
						});
					}
				});
			}

			data.fileUrls = uploadedFiles;

			try {
				const response = await fetch(contactApiEndpoint, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify(data)
				});

				if (response.ok) {
					trackLeadGeneration();
					form.reset();
					if (fileList) fileList.innerHTML = '';
					if (storedFileMap) storedFileMap.clear();
					clearMessage();
					showSuccessState();
				} else {
					throw new Error('Server error');
				}
			} catch (error) {
				showMessage('mt-4 p-4 rounded-lg bg-red-100 text-red-800', 'Es ist ein Fehler aufgetreten. Bitte versuchen Sie es erneut oder kontaktieren Sie uns direkt per Telefon.');
			} finally {
				if (submitButton) {
					submitButton.disabled = false;
					submitButton.innerHTML = originalText;
				}
			}
		});
	} else if (form) {
		form.addEventListener('submit', (e) => {
			e.preventDefault();

			if (privacyCheckbox && !privacyCheckbox.checked) {
				showMessage('mt-4 p-4 rounded-lg bg-red-100 text-red-800', 'Bitte bestätigen Sie die Datenschutzerklärung.');
				privacyCheckbox.focus();
				return;
			}

			const formData = new FormData(form);
			const data = {
				name: formData.get('name') || '',
				contact: formData.get('contact'),
				message: formData.get('message'),
				privacy: formData.get('privacy') === 'on',
				timestamp: new Date().toISOString(),
				source: formId.includes('overlay') ? 'overlay-form' : 'landing-page'
			};

			trackLeadGeneration();
			form.reset();
			if (fileList) fileList.innerHTML = '';
			clearMessage();
			showSuccessState();
		});
	}
</script>

