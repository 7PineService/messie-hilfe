---
import { getGTMContainerId, shouldExcludeTracking } from '@/config/tracking';
import { SITE_URL, CONTACT_EMAIL, CONTACT_PHONE, CONTACT_PHONE_DISPLAY, SITE_NAME } from '@/config/site';
import SEO from '@/components/head/seo.astro';
import Tracking from '@/components/head/tracking.astro';
import SpeedInsights from '@/components/head/speed-insights.astro';
import Footer from '@/components/layout/footer.astro';
import { FinalCTA } from '@/components/sections';
import '@/styles/global.css';

interface Props {
	title: string;
	description?: string;
	image?: string;
	canonicalUrl?: string;
	noindex?: boolean;
	currentStep?: number;
	totalSteps?: number;
}

const {
	title,
	description,
	image,
	canonicalUrl,
	noindex = false,
	currentStep = 1,
	totalSteps = 6
} = Astro.props;

const currentPath = Astro.url.pathname;
const hostname = Astro.url.hostname;

const fullTitle = `${title} | Messie-Hilfe`;
const finalCanonicalUrl = canonicalUrl || `${SITE_URL}${currentPath}`;

const excludeTracking = shouldExcludeTracking(currentPath);
const gtmId = getGTMContainerId(hostname);
---

<!doctype html>
<html lang="de">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
		<meta name="generator" content={Astro.generator}>

		<SEO
			title={fullTitle}
			description={description}
			image={image}
			canonicalUrl={finalCanonicalUrl}
			noindex={noindex}
			currentPath={currentPath}
		/>

		{!excludeTracking && <Tracking gtmId={gtmId} />}
		<SpeedInsights />

		<slot name="head" />
	</head>

	<body class="antialiased bg-surface-muted min-h-screen flex flex-col">
		{!excludeTracking && (
			<noscript>
				<iframe
					src={`https://www.googletagmanager.com/ns.html?id=${gtmId}`}
					height="0"
					width="0"
					style="display:none;visibility:hidden"
				/>
			</noscript>
		)}

		<header class="z-50 relative border-b border-border-primary">
			<div class="bg-surface-muted">
				<div class="container mx-auto px-4 py-2.5">
					<div class="flex flex-wrap items-center justify-between text-sm">
						<a href={`mailto:${CONTACT_EMAIL}`}>
							{CONTACT_EMAIL}
						</a>
						<a href={`tel:${CONTACT_PHONE}`} data-gtm-event="contact_call">
							{CONTACT_PHONE_DISPLAY}
						</a>
					</div>
				</div>
			</div>

			<nav class="bg-surface-secondary" aria-label="Formular-Navigation">
				<div class="container mx-auto px-4">
					<div class="flex items-center justify-between md:justify-center md:relative h-18">
						<a href="/" class="flex items-center gap-2 md:absolute md:left-0" aria-label={`${SITE_NAME} Startseite`}>
							<img src="/logo.svg" alt={`${SITE_NAME} Logo`} class="max-h-14 h-auto w-auto object-contain" />
							<div class="relative">
								<span class="text-xl whitespace-nowrap logo-text">
									<span class="messie">Messie-</span><span class="hilfe">Hilfe</span>
								</span>
								<span class="deutschland absolute top-6 left-0 whitespace-nowrap">Deutschland</span>
							</div>
						</a>

						<div class="step-indicator flex flex-col items-center text-base font-medium">
							<span class="text-primary">Schritt {currentStep} von {totalSteps}</span>
							<div class="mt-2 w-32 h-1.5 bg-surface-muted rounded-full overflow-hidden">
								<div
									class="h-full bg-cta-primary rounded-full transition-all duration-300"
									style={`width: ${(currentStep / totalSteps) * 100}%`}
								></div>
							</div>
						</div>
					</div>
				</div>
			</nav>
		</header>

		<main class="flex-1">
			<slot />
		</main>

		<Footer />
	</body>
</html>

<style>
	.messie {
		font-weight: 600;
		color: var(--color-logo-messie);
	}

	.hilfe {
		font-weight: 400;
		color: #8B7A6A;
	}

	.deutschland {
		font-weight: 300;
		font-size: 0.9rem;
		color: #8F887F;
		opacity: 0.3;
	}
</style>
