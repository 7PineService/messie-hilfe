---
import { cn } from '@/utils/cn';

interface Props {
	name?: string;
	id?: string;
	accept?: string;
	multiple?: boolean;
	disabled?: boolean;
	class?: string;
	description?: string;
	buttonText?: string;
	variant?: 'default' | 'compact';
	[key: string]: any;
}

const {
	name = 'files',
	id = 'lead-form-files',
	accept = 'image/*,.pdf,.mp4,.mov',
	multiple = true,
	disabled = false,
	class: className = '',
	description,
	buttonText,
	variant = 'default',
	...rest
} = Astro.props;

const fileListId = `${id}-list`;
---

<div class={cn('file-upload-container', className)} data-file-upload={id} {...rest}>
	<input
		type="hidden"
		id={`${id}-data`}
		name={`${name}_data`}
		value=""
	/>
	<div class="border-2 border-dashed border-outline rounded-lg p-6 hover:border-bronze transition-colors bg-warm-300">
		<input
			type="file"
			id={id}
			name={name}
			accept={accept}
			multiple={multiple}
			disabled={disabled}
			class="hidden"
		/>
		<label for={id} class={cn(
			"cursor-pointer flex gap-3",
			variant === 'compact' ? 'flex-row items-center' : 'flex-col items-center'
		)}>
			<div class="w-12 h-12 rounded-lg flex items-center justify-center border border-dashed shrink-0" style="background-color: var(--color-warm-400); border-color: var(--color-outline-golden);">
				<svg class="w-6 h-6 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
					<path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
				</svg>
			</div>
			<div class={variant === 'compact' ? 'text-left' : 'text-center'}>
				<p class="text-sm font-medium">Dateien hierhin ziehen oder auswählen</p>
				{description && (
					<p class="text-xs text-foreground-muted mt-1">{description}</p>
				)}
			</div>
			{buttonText && (
				<span class="inline-flex items-center justify-center px-4 py-2 text-sm font-medium rounded-lg bg-warm-200 border border-outline hover:bg-warm-250 transition-colors">
					{buttonText}
				</span>
			)}
		</label>
	</div>

	<div id={fileListId} class="mt-3 space-y-2"></div>
	<div id={`${id}-error`} class="mt-2 text-sm text-red-600 hidden"></div>
</div>

<script is:inline define:vars={{ fileUploadId: id }}>
	document.addEventListener('DOMContentLoaded', () => {
		const fileInputEl = document.getElementById(fileUploadId);
		const fileListEl = document.getElementById(`${fileUploadId}-list`);
		const errorContainerEl = document.getElementById(`${fileUploadId}-error`);
		const containerEl = document.querySelector(`[data-file-upload="${fileUploadId}"]`);
		const hiddenInputEl = document.getElementById(`${fileUploadId}-data`);

		if (!fileInputEl || !fileListEl || !containerEl || !hiddenInputEl) return;

		const fileInput = fileInputEl;
		const fileList = fileListEl;
		const errorContainer = errorContainerEl;
		const container = containerEl;
		const hiddenInput = hiddenInputEl;

		const fileMap = new Map();
		let fileIdCounter = 0;
		const MAX_FILE_SIZE = 40 * 1024 * 1024;

		function syncHiddenInput() {
			const uploadedFiles = [];
			fileMap.forEach((fileData) => {
				if (fileData.status === 'uploaded' && fileData.url) {
					uploadedFiles.push({
						url: fileData.url,
						name: fileData.name,
						size: fileData.size,
						path: fileData.path
					});
				}
			});
			hiddenInput.value = JSON.stringify(uploadedFiles);
		}

		function showError(message) {
			if (errorContainer) {
				errorContainer.textContent = message;
				errorContainer.classList.remove('hidden');
				setTimeout(() => {
					errorContainer.classList.add('hidden');
				}, 5000);
			}
		}

		async function uploadToSupabase(file) {
			const urlResponse = await fetch('/api/upload-url', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({
					fileName: file.name,
					fileType: file.type,
					fileSize: file.size
				})
			});

			if (!urlResponse.ok) {
				const errorData = await urlResponse.json();
				throw new Error(errorData.error || 'Failed to get upload URL');
			}

			const { signedUrl, path, publicUrl } = await urlResponse.json();

			const uploadResponse = await fetch(signedUrl, {
				method: 'PUT',
				body: file,
				headers: {
					'Content-Type': file.type,
					'x-upsert': 'false'
				}
			});

			if (!uploadResponse.ok) {
				throw new Error('Upload fehlgeschlagen');
			}

			return {
				url: publicUrl,
				path: path,
				name: file.name,
				size: file.size,
			};
		}

		async function addFile(file) {
			if (file.size > MAX_FILE_SIZE) {
				showError(`Die Datei "${file.name}" ist zu groß. Maximale Größe: 40MB`);
				return;
			}

			const fileId = `file-${fileIdCounter++}`;

			const tempFileData = {
				name: file.name,
				size: file.size,
				status: 'uploading',
				url: null,
				path: null
			};

			fileMap.set(fileId, tempFileData);
			renderFileList();

			try {
				const uploadResult = await uploadToSupabase(file);

				fileMap.set(fileId, {
					...tempFileData,
					status: 'uploaded',
					url: uploadResult.url,
					path: uploadResult.path
				});
				renderFileList();
				syncHiddenInput();
			} catch (error) {
				console.error('Upload error:', error);
				fileMap.set(fileId, {
					...tempFileData,
					status: 'error',
					error: error instanceof Error ? error.message : 'Unknown error'
				});
				renderFileList();
				showError(`Fehler beim Hochladen von "${file.name}": ${error instanceof Error ? error.message : 'Unknown error'}`);
			}
		}

		function removeFile(fileId) {
			fileMap.delete(fileId);
			renderFileList();
			syncHiddenInput();
		}

		function formatFileSize(bytes) {
			if (bytes >= 1024 * 1024) {
				return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
			}
			return `${(bytes / 1024).toFixed(1)} KB`;
		}

		function renderFileList() {
			fileList.innerHTML = '';

			fileMap.forEach((fileData, fileId) => {
				const fileItem = document.createElement('div');
				fileItem.className = 'text-sm flex items-center justify-between gap-2 p-2 bg-warm-300 rounded-lg border border-outline';

				const fileInfo = document.createElement('div');
				fileInfo.className = 'flex items-center gap-2 flex-1 min-w-0';

				let statusIcon = '';
				let statusText = '';

				if (fileData.status === 'uploading') {
					statusIcon = `<svg class="w-4 h-4 shrink-0 text-amber-600 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
					</svg>`;
					statusText = '<span class="text-amber-600 text-xs">Wird hochgeladen...</span>';
				} else if (fileData.status === 'uploaded') {
					statusIcon = `<svg class="w-4 h-4 shrink-0 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
					</svg>`;
					statusText = '';
				} else if (fileData.status === 'error') {
					statusIcon = `<svg class="w-4 h-4 shrink-0 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
					</svg>`;
					statusText = '<span class="text-red-600 text-xs">Fehler</span>';
				}

				fileInfo.innerHTML = `
					${statusIcon}
					<span class="truncate">${fileData.name}</span>
					<span class="text-foreground-muted shrink-0">(${formatFileSize(fileData.size)})</span>
					${statusText}
				`;

				const removeBtn = document.createElement('button');
				removeBtn.type = 'button';
				removeBtn.className = 'shrink-0 p-1 text-red-600 hover:text-red-800 hover:bg-red-50 rounded transition-colors';
				removeBtn.setAttribute('aria-label', 'Datei entfernen');
				removeBtn.disabled = fileData.status === 'uploading';
				removeBtn.innerHTML = `
					<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
					</svg>
				`;
				removeBtn.addEventListener('click', () => removeFile(fileId));

				fileItem.appendChild(fileInfo);
				fileItem.appendChild(removeBtn);
				fileList.appendChild(fileItem);
			});
		}

		fileInput.addEventListener('change', (e) => {
			const target = e.target;
			const newFiles = Array.from(target.files || []);
			newFiles.forEach(file => addFile(file));
			fileInput.value = '';
		});

		const dropZone = container.querySelector('label');

		['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
			dropZone?.addEventListener(eventName, (e) => {
				e.preventDefault();
				e.stopPropagation();
			});
		});

		['dragenter', 'dragover'].forEach(eventName => {
			dropZone?.addEventListener(eventName, () => {
				dropZone.parentElement?.classList.add('border-bronze', 'bg-warm-250');
			});
		});

		['dragleave', 'drop'].forEach(eventName => {
			dropZone?.addEventListener(eventName, () => {
				dropZone.parentElement?.classList.remove('border-bronze', 'bg-warm-250');
			});
		});

		dropZone?.addEventListener('drop', (e) => {
			const dragEvent = e;
			const files = Array.from(dragEvent.dataTransfer?.files || []);
			files.forEach(file => addFile(file));
		});

		const parentForm = fileInput.closest('form');
		if (parentForm) {
			parentForm.addEventListener('reset', () => {
				fileMap.clear();
				renderFileList();
				syncHiddenInput();
			});
		}
	});
</script>
