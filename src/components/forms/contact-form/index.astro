---
import { CONTACT_API_ENDPOINT } from '@/config/site';
import { FileUpload } from '@/components/ui';

interface Props {
	formId?: string;
	formMessageId?: string;
	privacyCheckboxId?: string;
	nameInputId?: string;
	contactInputId?: string;
	messageInputId?: string;
	filesInputId?: string;
	showTitle?: boolean;
	overlayStyle?: boolean;
	formTitle?: string;
	submitButtonText?: string;
	formType?: 'anonym' | 'contact';
	formLocation?: string;
}

const {
	formId = 'contact-form',
	formMessageId = 'form-message',
	privacyCheckboxId = 'privacy',
	nameInputId = 'name',
	contactInputId = 'contact',
	messageInputId = 'message',
	filesInputId = 'files',
	showTitle = true,
	overlayStyle = false,
	formTitle = 'Anonym anfragen',
	submitButtonText = 'Anonym anfragen',
	formType = 'contact',
	formLocation = null
} = Astro.props;

const contactApiEndpoint = CONTACT_API_ENDPOINT;

const containerClass = overlayStyle
	? 'px-4 md:px-6 pb-4 md:pb-6'
	: 'bg-warm-200 rounded-2xl shadow-xl px-6 py-6';
const inputBgClass = 'bg-warm-300';
const borderClass = 'border-outline';
const focusBorderClass = 'focus:ring-2 focus:ring-outline focus:border-outline';
const buttonClass = 'cta-primary w-full text-white font-semibold px-5 py-2.5 border-2 border-transparent rounded-lg flex items-center justify-center space-x-2 text-base';
---

<div class={`${containerClass} ${!overlayStyle ? 'text-center' : ''}`} id={overlayStyle ? undefined : 'anfrage'}>
	{showTitle && (
		<h2 class={`text-2xl ${overlayStyle ? 'font-semibold' : 'md:text-3xl font-bold'} text-center ${overlayStyle ? '' : 'mb-4'}`}>
			{formTitle}
		</h2>
	)}
	
	<form
		id={formId}
		class="space-y-3 min-[1920px]:space-y-4"
		method="POST"
		action={contactApiEndpoint || '#'}
	>
		<div>
			<input
				type="text"
				id={nameInputId}
				name="name"
				class={`w-full px-3 py-2 min-[1920px]:px-4 min-[1920px]:py-3 text-sm min-[1920px]:text-base border ${borderClass} rounded-lg ${focusBorderClass} transition-colors ${inputBgClass}`}
				placeholder="Name (optional)"
			/>
		</div>

		<div>
			<input
				type="text"
				id={contactInputId}
				name="contact"
				required
				class={`w-full px-3 py-2 min-[1920px]:px-4 min-[1920px]:py-3 text-sm min-[1920px]:text-base border ${borderClass} rounded-lg ${focusBorderClass} transition-colors ${inputBgClass}`}
				placeholder="Telefon oder E-Mail"
			/>
		</div>

		<div>
			<textarea
				id={messageInputId}
				name="message"
				rows={overlayStyle ? 3 : 4}
				required
				class={`w-full px-3 py-2 min-[1920px]:px-4 min-[1920px]:py-3 text-sm min-[1920px]:text-base border ${borderClass} rounded-lg ${focusBorderClass} transition-colors ${inputBgClass} resize-none`}
				placeholder="Ihre Nachricht"
			></textarea>
		</div>

		<div>
			<FileUpload
				name="files"
				id={filesInputId}
				accept="image/*,.pdf,.mp4,.mov"
				multiple={true}
				variant="compact"
			/>
		</div>

		<div class="flex items-start gap-2 pt-1">
			<input
				type="checkbox"
				id={privacyCheckboxId}
				name="privacy"
				required
				class="mt-0.5 w-4 h-4 border-outline rounded focus:ring-outline focus:ring-2"
			/>
			<label for={privacyCheckboxId} class="text-xs opacity-80 leading-normal">
				Ich habe die Datenschutzerklärung zur Kenntnis genommen
			</label>
		</div>

		<button
			type="submit"
			class={buttonClass}
		>
			<span>{submitButtonText}</span>
			<svg class="w-7 h-7" viewBox="0 0 24 24" fill="none">
				<circle cx="12" cy="12" r="10" fill="white" />
				<path d="M10 8l6 4-6 4V8z" fill="var(--color-foreground)" />
			</svg>
		</button>

		<div class="text-center pt-2 space-y-1">
			<p class="text-xs opacity-60">
				100 % anonym – keine Weitergabe Ihrer Daten
			</p>
			<p class="text-xs opacity-40">
				Kommt es zu keinem Auftrag, löschen wir Ihre Daten spätestens nach 14 Tagen automatisch.
			</p>
		</div>
	</form>

	<div id={`${formId}-success`} class="hidden text-center py-8">
		<div class="mb-4 flex justify-center">
			<svg class="w-16 h-16 md:w-20 md:h-20 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
			</svg>
		</div>

		<h3 class="text-2xl md:text-3xl font-semibold mb-4">Vielen Dank.</h3>

		<div class="space-y-3 text-base opacity-80">
			{formType === 'anonym' ? (
				<>
					<p>Ihre anonyme Anfrage ist bei uns angekommen.</p>
					<p>Wir melden uns – sofern möglich – zeitnah bei Ihnen.</p>
					{overlayStyle && <p class="opacity-60">Sie können dieses Fenster jetzt schließen.</p>}
				</>
			) : (
				<>
					<p>Ihre anonyme Anfrage ist bei uns angekommen.</p>
					<p>Wir melden uns – sofern möglich – zeitnah bei Ihnen.</p>
				</>
			)}
		</div>
	</div>
</div>

<script define:vars={{ contactApiEndpoint, formId, formMessageId, privacyCheckboxId, filesInputId, overlayStyle, isDev: import.meta.env.DEV, formType, formLocation }}>

	const form = document.getElementById(formId);
	let formMessage = null;
	const privacyCheckbox = document.getElementById(privacyCheckboxId);

	function getMessageElement() {
		if (!formMessage) {
			formMessage = document.createElement('div');
			formMessage.id = formMessageId;
			form.appendChild(formMessage);
		}
		return formMessage;
	}

	function showMessage(className, text) {
		const msg = getMessageElement();
		msg.className = className;
		msg.textContent = text;
	}

	function clearMessage() {
		if (formMessage && formMessage.parentNode) {
			formMessage.parentNode.removeChild(formMessage);
			formMessage = null;
		}
	}

	const successElement = document.getElementById(`${formId}-success`);

	function showSuccessState() {
		if (!form || !successElement) return;
		form.style.display = 'none';
		successElement.classList.remove('hidden');
		successElement.classList.add('block');
		successElement.scrollIntoView({ behavior: 'smooth', block: 'center' });

		const overlayTitle = document.getElementById('overlay-title');
		if (overlayTitle) {
			overlayTitle.style.display = 'none';
		}
	}

	function resetToFormState() {
		if (!form || !successElement) return;
		form.style.display = 'block';
		successElement.classList.add('hidden');
		successElement.classList.remove('block');

		const overlayTitle = document.getElementById('overlay-title');
		if (overlayTitle) {
			overlayTitle.style.display = '';
		}
	}

	let eventFired = false;

	function trackLeadGeneration() {
		if (eventFired) {
			if (isDev) console.warn('[Tracking] Event already fired, skipping duplicate');
			return;
		}

		if (typeof window === 'undefined' || !window.dataLayer) {
			if (isDev) console.warn('[Tracking] dataLayer not available');
			return;
		}

		let detectedFormLocation = formLocation;
		if (!detectedFormLocation) {
			if (overlayStyle) {
				detectedFormLocation = 'modal';
			} else if (formId.includes('hero')) {
				detectedFormLocation = 'hero';
			} else if (window.location.pathname.includes('kontakt')) {
				detectedFormLocation = 'kontakt';
			} else {
				detectedFormLocation = 'startseite';
			}
		}

		const eventData = {
			'event': 'contact_form_submit',
			'form_type': formType,
			'form_location': detectedFormLocation
		};

		if (isDev) {
			console.log('[Tracking] ✅ Firing contact_form_submit event');
			console.log('[Tracking] Event data:', eventData);
		}

		window.dataLayer.push(eventData);
		eventFired = true;
	}

	if (typeof window !== 'undefined') {
		const resetFunctionName = `resetFormTracking_${formId.replace(/-/g, '')}`;
		window[resetFunctionName] = () => {
			eventFired = false;
			resetToFormState();
			if (isDev) console.log(`[Tracking] Reset form tracking for ${formId}`);
		};
	}

	if (form && contactApiEndpoint) {
		form.addEventListener('submit', async (e) => {
			e.preventDefault();

			if (privacyCheckbox && !privacyCheckbox.checked) {
				showMessage('mt-4 p-4 rounded-lg bg-red-100 text-red-800', 'Bitte bestätigen Sie die Datenschutzerklärung.');
				privacyCheckbox.focus();
				return;
			}

			const submitButton = form.querySelector('button[type="submit"]');
			if (!submitButton) return;
			const originalText = submitButton.innerHTML;
			submitButton.disabled = true;
			submitButton.innerHTML = '<span>Wird gesendet...</span>';

			const formData = new FormData(form);
			const data = {
				name: formData.get('name') || '',
				contact: formData.get('contact'),
				message: formData.get('message'),
				privacy: formData.get('privacy') === 'on',
				timestamp: new Date().toISOString(),
				source: formId.includes('overlay') ? 'overlay-form' : 'landing-page'
			};

			const filesDataInput = document.getElementById(`${filesInputId}-data`);
			const uploadedFiles = filesDataInput && filesDataInput.value
				? JSON.parse(filesDataInput.value)
				: [];

			data.fileUrls = uploadedFiles;

			try {
				const response = await fetch(contactApiEndpoint, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify(data)
				});

				if (response.ok) {
					trackLeadGeneration();
					form.reset();
					clearMessage();
					showSuccessState();
				} else {
					throw new Error('Server error');
				}
			} catch (error) {
				showMessage('mt-4 p-4 rounded-lg bg-red-100 text-red-800', 'Es ist ein Fehler aufgetreten. Bitte versuchen Sie es erneut oder kontaktieren Sie uns direkt per Telefon.');
			} finally {
				if (submitButton) {
					submitButton.disabled = false;
					submitButton.innerHTML = originalText;
				}
			}
		});
	} else if (form) {
		form.addEventListener('submit', (e) => {
			e.preventDefault();

			if (privacyCheckbox && !privacyCheckbox.checked) {
				showMessage('mt-4 p-4 rounded-lg bg-red-100 text-red-800', 'Bitte bestätigen Sie die Datenschutzerklärung.');
				privacyCheckbox.focus();
				return;
			}

			const formData = new FormData(form);
			const data = {
				name: formData.get('name') || '',
				contact: formData.get('contact'),
				message: formData.get('message'),
				privacy: formData.get('privacy') === 'on',
				timestamp: new Date().toISOString(),
				source: formId.includes('overlay') ? 'overlay-form' : 'landing-page'
			};

			trackLeadGeneration();
			form.reset();
			clearMessage();
			showSuccessState();
		});
	}
</script>

